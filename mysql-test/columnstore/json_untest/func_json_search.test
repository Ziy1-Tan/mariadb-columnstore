--source ../include/have_columnstore.inc
--disable_warnings
DROP DATABASE IF EXISTS json_search_db;

--enable_warnings
CREATE DATABASE json_search_db;

USE json_search_db;

--echo # ----------------------------------------------------------------------
--echo # Test of JSON_SEARCH function.
--echo # ----------------------------------------------------------------------
CREATE TABLE t1(j TEXT, f TEXT, v TEXT) ENGINE = columnstore;

INSERT INTO
    t1
VALUES
    (
        '["abc", [{"k": "10"}, "def"], {"x":"abc"}, {"y":"bcd"}]',
        'one',
        'abc'
    ),
    (
        '["abc", [{"k": "10"}, "def"], {"x":"abc"}, {"y":"bcd"}]',
        'all',
        'abc'
    ),
    ('{"x": "\\""}', "one", '"'),
    ('{"x": "\\""}', "one", '\\"');

SELECT
    j,
    f,
    v,
    JSON_SEARCH(j, f, v)
FROM
    t1;

CREATE TABLE t2(j TEXT, f TEXT, v TEXT, e TEXT, p TEXT) ENGINE = columnstore;

INSERT INTO
    t2
VALUES
    (@j, 'all', 'abc', NULL, '$[2]'),
    (@j, 'all', 'abc', NULL, '$'),
    (@j, 'all', '10', NULL, '$'),
    (@j, 'all', '10', NULL, '$[*]'),
    (@j, 'all', '10', NULL, '$[*][0].k'),
    (@j, 'all', '10', NULL, '$**.k');

SELECT
    j,
    f,
    v,
    e,
    p,
    JSON_SEARCH(j, f, v)
FROM
    t2;

DROP TABLE t2;

DROP TABLE t1;

DROP DATABASE json_search_db;
