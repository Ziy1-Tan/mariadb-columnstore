#-- source ../include/have_columnstore.inc
--disable_warnings
DROP DATABASE IF EXISTS json_exists_db;

--enable_warnings
CREATE DATABASE json_exists_db;

USE json_exists_db;

--echo # ----------------------------------------------------------------------
--echo # Test of JSON_EXISTS function.
--echo # ----------------------------------------------------------------------
--echo # Test case 0
CREATE TABLE t1(j TEXT, p TEXT) ENGINE = columnstore;

SET
      @json = '{"key1":"xxxx", "key2":[1, 2, 3]}';

INSERT INTO
      t1
VALUES
      (@json, '$.key1'),
      (@json, '$.key1[0]'),
      (@json, '$.key2'),
      (@json, '$.key2[1]'),
      (@json, '$.key2[10]');

SELECT
      j,
      p,
      JSON_EXISTS(j, p) AS result
FROM
      t1;

--echo # Test case 1
CREATE TABLE t2(j TEXT, p TEXT) ENGINE = columnstore;

SET
      @json = '{
            "A": [0,
                  [1, 2, 3],
                  [4, 5, 6],
                  "seven",
                   0.8,
                   true,
                   false,
                   "eleven",
                  [12, 13, {"key1":"value1"},[15]],
                  true],
            "B": {"C": 1},
            "D": 2
           }';

INSERT INTO
      t2
VALUES
      (@json, '$.A[-2][-1]'),
      (@json, '$.A[last-1][last]');

SELECT
      j,
      p,
      JSON_EXISTS(j, p) AS result
FROM
      t2;

--echo # Test case 2
CREATE TABLE t3(j TEXT, p TEXT) ENGINE = columnstore;

SET
      @json = '[
             [1, {"key1": "value1"}, 3],
             [false, 5, 6],
             [7, 8, [9, {"key2": 2}, 11]],
             [15, 1.34, [14], ["string1", [16, {"key1":[1,2,3,[4,5,6]]}, 18]]],
             [19, 20],
             21, 22
            ]';

INSERT INTO
      t3
VALUES
      (@json, '$[3][3][-2 to last]');

SELECT
      j,
      p,
      JSON_EXISTS(j, p) AS result
FROM
      t3;

-- echo # Test case 3
CREATE TABLE t4(j TEXT, p TEXT) ENGINE = columnstore;

SET
      @json = '[
             [1, {"key1": "value1"}, 3],
             [false, 5, 6],
             [7, 8, [9, {"key2": 2}, 11]],
             [15, 1.34, [14], ["string1", [16, {"key1":[1,2,3,[4,5,6]]}, 18]]],
             [19, 20],
             21, 22
            ]';

INSERT INTO
      t4
VALUES
      (@json, '$[2][2][1 to 2]'),
      (@json, '$[2][2][4 to 6]'),
      (@json, '$[2][2][1 to 4]');

SELECT
      j,
      p,
      JSON_EXISTS(j, p) AS result
FROM
      t4;

DROP TABLE t4;

DROP TABLE t3;

DROP TABLE t2;

DROP TABLE t1;

DROP DATABASE json_exists_db;
